<!DOCTYPE html>
<html>

<head>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body {
            margin: 0;
            padding: 0;
            background-color: white;
            width: 100%;
            height: 100%;
            min-width: 240px;
            min-height: 300px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        .variable-list {
            width: 100%;
            height: calc(100% - 40px);
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            padding: 16px;
        }
        
        .empty-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #333;
        }
        
        .loading {
            font-size: 14px;
            color: #666;
        }
        
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 1000;
        }
        
        .resize-handle.right {
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
        }
        
        .resize-handle.left {
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
        }
        
        .variable-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .variable-name {
            font-weight: 500;
        }
        
        .variable-value {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #333;
        }
        
        .color-preview {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 4px;
            border: 1px solid #e5e5e5;
        }
        
        .collection-dropdown {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <select id="collectionDropdown" class="collection-dropdown">
      <option value="all">All Collections</option>
    </select>

    <div id="variableList" class="variable-list">
        <div class="empty-message">
            <div class="loading">Loading variables...</div>
        </div>
    </div>

    <div id="resizeHandleLeft" class="resize-handle left"></div>
    <div id="resizeHandleRight" class="resize-handle right"></div>

    <script>
        let allVariables = [];
        let collectionMap = {};

        window.onmessage = (event) => {
            const message = event.data.pluginMessage;
            console.log('Received message:', message); // Debug log

            if (!message || !message.type) {
                console.error('Invalid message received');
                return;
            }

            const variableList = document.getElementById('variableList');
            const collectionDropdown =
                document.getElementById('collectionDropdown');

            switch (message.type) {
                case 'init-resize':
                    // Execute the resize script
                    eval(message.script);
                    break;

                case 'empty':
                    variableList.innerHTML = `<div class="empty-message">${message.message}</div>`;
                    break;

                case 'error':
                    variableList.innerHTML = `<div class="empty-message" style="color: red;">${message.message}</div>`;
                    break;

                case 'variables':
                    variableList.innerHTML = ''; // Clear loading message
                    allVariables = message.variables;
                    collectionMap = message.collections.reduce((acc, collection) => {
                        acc[collection] = allVariables.filter(
                            (v) => v.collection === collection,
                        );
                        return acc;
                    }, {});

                    // Populate dropdown
                    message.collections.forEach((collection) => {
                        const option = document.createElement('option');
                        option.value = collection;
                        option.textContent = collection;
                        collectionDropdown.appendChild(option);
                    });

                    // Show all variables by default
                    displayVariables(allVariables);
                    break;

                default:
                    console.error('Unknown message type:', message.type);
            }
        };

        function displayVariables(variables) {
            const variableList = document.getElementById('variableList');
            variableList.innerHTML = '';

            if (variables.length === 0) {
                variableList.innerHTML =
                    '<div class="empty-message">No variables found</div>';
                return;
            }

            variables.forEach((variable) => {
                console.log('Processing variable:', variable);

                const div = document.createElement('div');
                div.className = 'variable-item';

                const name = document.createElement('div');
                name.className = 'variable-name';
                name.textContent = variable.name;

                const valueContainer = document.createElement('div');
                valueContainer.className = 'variable-value';

                if (
                    variable.value &&
                    typeof variable.value === 'object' &&
                    'type' in variable.value &&
                    variable.value.type === 'VARIABLE_ALIAS'
                ) {
                    // This is a reference variable
                    valueContainer.textContent = `â†’ ${
              variable.referenceName || 'Unknown reference'
            }`;
                    valueContainer.style.color = '#666';
                } else {
                    // Handle primitive values
                    switch (variable.type) {
                        case 'COLOR':
                            if (variable.value && typeof variable.value === 'object') {
                                const {
                                    r,
                                    g,
                                    b
                                } = variable.value;
                                const hex = rgbToHex(r, g, b);
                                const colorPreview = document.createElement('div');
                                colorPreview.className = 'color-preview';
                                colorPreview.style.backgroundColor = hex;
                                valueContainer.appendChild(colorPreview);
                                valueContainer.appendChild(document.createTextNode(hex));
                            }
                            break;

                        case 'FLOAT':
                        case 'NUMBER':
                            if (typeof variable.value === 'number') {
                                valueContainer.textContent = variable.value.toFixed(2);
                            }
                            break;

                        default:
                            valueContainer.textContent = String(variable.value);
                    }
                }

                div.appendChild(name);
                div.appendChild(valueContainer);
                variableList.appendChild(div);
            });
        }

        function rgbToHex(r, g, b) {
            return (
                '#' + [r, g, b]
                .map((x) => {
                    const hex = Math.round(x * 255).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                })
                .join('')
            );
        }

        document
            .getElementById('collectionDropdown')
            .addEventListener('change', (event) => {
                const selectedCollection = event.target.value;
                if (selectedCollection === 'all') {
                    displayVariables(allVariables);
                } else {
                    displayVariables(collectionMap[selectedCollection] || []);
                }
            });
    </script>
</body>

</html>